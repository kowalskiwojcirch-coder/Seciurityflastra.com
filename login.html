<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Login | Security Flastra</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="logo">Securityflastra.com</div>
  <ul class="nav-links">
    <li><a href="index.html">Home Page</a></li>
    <li><a href="secretary.html">Secretary</a></li>
    <li><a href="login.html">Login</a></li>
    <li class="search">ğŸ”</li>
  </ul>
</nav>

<section class="login-section">
  <!-- PROFIL ZALOGOWANEGO UÅ»YTKOWNIKA -->
  <div id="profilePanel" class="profile-panel" style="display: none;">
    <div class="profile-card">
      <div class="profile-avatar">ğŸ‘¤</div>
      <h2 id="profileName"></h2>
      <p id="profileEmail"></p>
      <button id="logoutBtn" class="logout-btn">Wyloguj siÄ™</button>
    </div>
  </div>

  <!-- LOGOWANIE -->
  <div id="loginDiv" class="login-container">
    <h1>Logowanie</h1>
    <input type="text" id="loginEmail" placeholder="Email lub nazwa" required>
    <input type="password" id="loginPass" placeholder="HasÅ‚o" required>
    <button id="loginBtn">Zaloguj siÄ™</button>
    <p>Nie masz konta? <button id="toRegister" style="background: none; border: none; color: #4da3ff; cursor: pointer; text-decoration: underline; padding: 0;">Rejestracja</button></p>
    <div id="loginError" class="error-message" style="display: none;"></div>
  </div>

  <!-- REJESTRACJA -->
  <div id="registerDiv" class="login-container" style="display: none;">
    <h1>Rejestracja</h1>
    <input type="text" id="regUsername" placeholder="Nazwa uÅ¼ytkownika" required>
    <input type="text" id="regEmail" placeholder="Email" required>
    <input type="password" id="regPass" placeholder="HasÅ‚o" required>
    <input type="password" id="regPassConf" placeholder="PotwierdÅº hasÅ‚o" required>
    <div class="checkbox-group">
      <input type="checkbox" id="privacyCheck" required>
      <label for="privacyCheck">AkceptujÄ™ <strong>politykÄ™ prywatnoÅ›ci</strong> i <strong>pliki cookies</strong></label>
    </div>
    <button id="registerBtn">Zarejestruj siÄ™</button>
    <p>Masz juÅ¼ konto? <button id="toLogin" style="background: none; border: none; color: #4da3ff; cursor: pointer; text-decoration: underline; padding: 0;">Logowanie</button></p>
    <div id="regError" class="error-message" style="display: none;"></div>
  </div>
</section>

<footer>
  <p>&copy; 2024-2026 Security Flastra. Wszystkie prawa zastrzeÅ¼one.</p>
</footer>

<script>
const API_URL = 'http://localhost:3000';

// PRZEÅÄ„CZANIE MIÄ˜DZY FORMULARZAMI
document.getElementById('toRegister').onclick = function(e) {
  e.preventDefault();
  document.getElementById('loginDiv').style.display = 'none';
  document.getElementById('registerDiv').style.display = 'block';
};

document.getElementById('toLogin').onclick = function(e) {
  e.preventDefault();
  document.getElementById('registerDiv').style.display = 'none';
  document.getElementById('loginDiv').style.display = 'block';
};

// REJESTRACJA
document.getElementById('registerBtn').onclick = async function() {
  const username = document.getElementById('regUsername').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pass = document.getElementById('regPass').value;
  const passConf = document.getElementById('regPassConf').value;
  const privacyOk = document.getElementById('privacyCheck').checked;
  const errDiv = document.getElementById('regError');
  
  errDiv.style.display = 'none';
  
  if (!privacyOk) {
    errDiv.innerHTML = 'âŒ Musisz zaakceptowaÄ‡ politykÄ™ prywatnoÅ›ci!';
    errDiv.style.display = 'block';
    return false;
  }
  
  if (pass !== passConf) {
    errDiv.innerHTML = 'âŒ HasÅ‚a siÄ™ nie zgadzajÄ…!';
    errDiv.style.display = 'block';
    return false;
  }
  
  if (pass.length < 6) {
    errDiv.innerHTML = 'âŒ HasÅ‚o musi mieÄ‡ co najmniej 6 znakÃ³w!';
    errDiv.style.display = 'block';
    return false;
  }
  
  try {
    const response = await fetch(`${API_URL}/api/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username, email, password: pass, passwordConfirm: passConf
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      localStorage.setItem('loggedUser', email);
      localStorage.setItem('userName', username);
      
      document.getElementById('regUsername').value = '';
      document.getElementById('regEmail').value = '';
      document.getElementById('regPass').value = '';
      document.getElementById('regPassConf').value = '';
      document.getElementById('privacyCheck').checked = false;
      
      showProfile({ username, email });
    } else {
      errDiv.innerHTML = 'âŒ ' + data.error;
      errDiv.style.display = 'block';
    }
  } catch (err) {
    errDiv.innerHTML = 'âŒ BÅ‚Ä…d poÅ‚Ä…czenia z serwerem. Upewnij siÄ™ Å¼e serwer jest uruchomiony!';
    errDiv.style.display = 'block';
  }
};

// LOGOWANIE
document.getElementById('loginBtn').onclick = async function() {
  const input = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  const errDiv = document.getElementById('loginError');
  
  errDiv.style.display = 'none';
  
  try {
    const response = await fetch(`${API_URL}/api/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ input, password: pass })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      localStorage.setItem('loggedUser', data.user.email);
      localStorage.setItem('userName', data.user.username);
      localStorage.setItem('token', data.token);
      
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPass').value = '';
      
      showProfile(data.user);
    } else {
      errDiv.innerHTML = 'âŒ ' + data.error;
      errDiv.style.display = 'block';
    }
  } catch (err) {
    errDiv.innerHTML = 'âŒ BÅ‚Ä…d poÅ‚Ä…czenia z serwerem. Upewnij siÄ™ Å¼e serwer jest uruchomiony!';
    errDiv.style.display = 'block';
  }
};

// WYLOGOWANIE
document.getElementById('logoutBtn').onclick = function() {
  localStorage.removeItem('loggedUser');
  localStorage.removeItem('userName');
  localStorage.removeItem('token');
  document.getElementById('profilePanel').style.display = 'none';
  document.getElementById('loginDiv').style.display = 'block';
  document.getElementById('registerDiv').style.display = 'none';
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPass').value = '';
};

// POKAÅ» PROFIL
function showProfile(user) {
  document.getElementById('loginDiv').style.display = 'none';
  document.getElementById('registerDiv').style.display = 'none';
  document.getElementById('profilePanel').style.display = 'block';
  document.getElementById('profileName').textContent = user.username;
  document.getElementById('profileEmail').textContent = user.email;
}

// SPRAWDÅ¹ CZY JUÅ» ZALOGOWANY
window.onload = function() {
  const logged = localStorage.getItem('loggedUser');
  const userName = localStorage.getItem('userName');
  
  if (logged && userName) {
    showProfile({ email: logged, username: userName });
  }
};
</script>

</body>
</html>
